<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KNX ‚Üí OpenHAB Generator</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="icon" type="image/png" href="/static/favicon.png">
</head>

<body>
  <div class="container">
    <div class="header-container">
      <h1><img src="/static/favicon.png" class="header-icon" alt="Logo"> KNX ‚Üí OpenHAB Generator</h1>
      <div class="version-badge" id="versionBadge" onclick="checkForUpdates()" title="Click to check for updates">
        <span class="version-label">Version:</span>
        <span id="headerCommit">Loading...</span>
        <span class="update-indicator" id="updateIndicator" style="display:none;">üîÑ</span>
      </div>
    </div>

    <!-- Upload Section -->
    <section id="upload-section" class="card">
      <h2>üì§ Upload KNX Project</h2>
      <form id="uploadForm">
        <div class="form-group">
          <label for="fileInput">KNX Project File:</label>
          <input type="file" id="fileInput" name="file" accept=".knxproj,.knxprojarchive,.json" required />
        </div>
        <div class="form-group">
          <label for="passwordInput">Password (if protected):</label>
          <input type="password" id="passwordInput" name="password" placeholder="Optional" />
        </div>
        <div class="form-actions">
          <button type="button" onclick="previewProject()" class="btn-secondary">Preview Structure</button>
          <button type="submit" class="btn-primary">Upload & Process</button>
        </div>
      </form>
      <div id="status" class="status-message"></div>
    </section>

    <!-- Project Preview Section -->
    <section id="preview-section" class="card" style="display:none;">
      <h2>üè¢ Building Structure Preview</h2>
      <div id="previewMetadata" class="metadata-grid"></div>
      <div id="buildingTree" class="building-tree"></div>
    </section>


    <!-- Jobs Section -->
    <section id="jobs-section" class="card">
      <h2>üìã Jobs</h2>
      <div id="jobs" class="jobs-list"></div>
    </section>

    <!-- Job Details Section -->
    <section id="detail-section" class="card" style="display:none;">
      <h2>üìä Job Details</h2>
      <div id="jobDetail"></div>
    </section>

    <!-- Live Log Section -->
    <section id="log-section" class="card" style="display:none;">
      <h2>üìù Live Log</h2>
      <div style="margin-bottom: 1rem;">
        <label for="logLevelFilter">Log Level Filter:</label>
        <select id="logLevelFilter">
          <option value="all">All</option>
          <option value="debug">Debug</option>
          <option value="info">Info</option>
          <option value="warning">Warning</option>
          <option value="error">Error</option>
        </select>
      </div>
      <div id="log" class="log-viewer"></div>
    </section>

    <!-- Stats Section -->
    <section id="stats-section" class="card" style="display:none;">
      <div class="section-header">
        <h2>üìà Generated Files Statistics</h2>
        <label class="expert-toggle" title="Show completeness summary">
          <input type="checkbox" id="expertToggle">
          Expert
          <span class="expert-help">Completeness summary</span>
        </label>
      </div>
      <p class="muted">Tip: Reports like <code>unknown_report.json</code> and <code>partial_report.json</code> can be previewed, downloaded, or copied from the table.</p>
      <div id="expertPanel" class="expert-panel" style="display:none;"></div>
      <div id="stats"></div>
    </section>

    <!-- Settings Panel -->
    <section id="settings-section" class="card collapsible">
      <div class="card-header" onclick="toggleSection('settings-content')">
        <h2>‚öôÔ∏è Configuration Settings</h2>
        <span class="toggle-icon">‚ñº</span>
      </div>
      <div id="settings-content" class="collapsible-content" style="display: none;">
        <div class="tabs">
          <button class="tab-btn active" onclick="switchTab('general')">General</button>
          <button class="tab-btn" onclick="switchTab('devices')">Devices</button>
          <button class="tab-btn" onclick="switchTab('mappings')">Mappings</button>
          <button class="tab-btn" onclick="switchTab('definitions')">Definitions</button>
          <button class="tab-btn" onclick="switchTab('advanced')">Advanced</button>
        </div>

        <div id="config-forms" class="config-forms">
          <!-- General Tab -->
          <div id="tab-general" class="tab-content active">
            <!-- ETS Export Path removed -->
            <div class="form-group">
              <label>Items Path</label>
              <input type="text" id="conf-items-path" class="form-control">
            </div>
            <div class="form-group">
              <label>Things Path</label>
              <input type="text" id="conf-things-path" class="form-control">
            </div>
            <div class="form-group">
              <label>Sitemaps Path</label>
              <input type="text" id="conf-sitemaps-path" class="form-control">
            </div>
            <div class="form-group">
              <label>InfluxDB Path</label>
              <input type="text" id="conf-influx-path" class="form-control">
            </div>
            <div class="form-group">
              <label>Fenster Rules Path</label>
              <input type="text" id="conf-fenster-path" class="form-control">
            </div>

            <fieldset>
              <legend>Naming & Heuristics</legend>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <label><input type="checkbox" id="conf-floor-asis"> Floor Name As Is</label>
                  <div class="checkbox-help">Use the floor name exactly as defined in ETS.</div>
                </div>
                <div class="checkbox-item">
                  <label><input type="checkbox" id="conf-floor-desc"> Floor Name From Description</label>
                  <div class="checkbox-help">Use the ETS description field as the floor name.</div>
                </div>
                <div class="checkbox-item">
                  <label><input type="checkbox" id="conf-room-asis"> Room Name As Is</label>
                  <div class="checkbox-help">Use the room name exactly as defined in ETS.</div>
                </div>
                <div class="checkbox-item">
                  <label><input type="checkbox" id="conf-room-desc"> Room Name From Description</label>
                  <div class="checkbox-help">Use the ETS description field as the room name.</div>
                </div>
                <div class="checkbox-item">
                  <label><input type="checkbox" id="conf-add-missing"> Add Missing Items</label>
                  <div class="checkbox-help">Create OpenHAB items for GAs that have no explicit mapping.</div>
                </div>
                <div class="checkbox-item">
                  <label><input type="checkbox" id="conf-auto-place"> Auto-place unknown addresses</label>
                  <div class="checkbox-help">Create missing floors/rooms for unknown addresses to reduce ‚ÄúUnknown‚Äù reports.</div>
                </div>
              </div>
              <div class="info-box">
                Naming heuristics control how floors/rooms are inferred from ETS. Combine options as needed for your project structure.
              </div>
            </fieldset>
            <div class="form-group">
              <label>Unknown Floor Name</label>
              <input type="text" id="conf-unknown-floor" class="form-control">
            </div>
            <div class="form-group">
              <label>Unknown Room Name</label>
              <input type="text" id="conf-unknown-room" class="form-control">
            </div>
          </div>

          <!-- Devices Tab -->
          <div id="tab-devices" class="tab-content">
            <h3>Gateway</h3>
            <div class="form-group">
              <label>Hardware Names (comma separated)</label>
              <input type="text" id="conf-gateway-names" class="form-control">
              <small>Names to identify the KNX IP Interface/Router</small>
            </div>
          </div>

          <!-- Mappings Tab -->
          <div id="tab-mappings" class="tab-content">
            <div class="mappings-toolbar">
              <input type="text" id="mappingSearch" placeholder="Search mappings..." onkeyup="filterMappings()">
            </div>
            <div class="table-container">
              <table id="mappingsTable" class="data-table">
                <thead>
                  <tr>
                    <th>DPST</th>
                    <th>GA Prefix</th>
                    <th>Item Type</th>
                    <th>Semantic Info</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- Definitions Tab -->
          <div id="tab-definitions" class="tab-content">
            <div id="definitions-accordion">
              <!-- Populated by JS -->
            </div>
          </div>

          <!-- Advanced Tab -->
          <div id="tab-advanced" class="tab-content">
            <h3>Regex Patterns</h3>
            <div id="regex-container"></div>
          </div>
        </div>

        <div class="settings-actions">
          <button onclick="loadConfig()" class="btn-secondary">Reload Config</button>
          <div class="spacer"></div>
          <button onclick="saveConfig(true)" class="btn-secondary btn-outline">Save & Reprocess Last Job</button>
          <button onclick="saveConfig(false)" class="btn-primary">Save Config</button>
        </div>
        <div id="configStatus" class="status-message"></div>
      </div>
    </section>

    <!-- Services Section -->
    <section id="service-section" class="card">
      <h2>üîå Services</h2>
      <div id="servicesList"></div>
    </section>

    <div style="text-align: center; margin-top: 20px; margin-bottom: 20px; font-size: 12px; color: var(--text-light);">
      <a href="https://github.com/diddip21/knx_to_openhab/blob/main/README.md" target="_blank"
        style="color: inherit; text-decoration: none; border-bottom: 1px dotted var(--text-light);">README</a>
    </div>
  </div>

  <!-- Update Dialog -->
  <dialog id="updateDialog" class="update-dialog">
    <div class="dialog-header">
      <h2>üîÑ System Update Available</h2>
      <button class="close-btn" onclick="document.getElementById('updateDialog').close()">‚úï</button>
    </div>
    <div class="dialog-content">
      <div class="update-info-section">
        <h3>Current Version</h3>
        <div class="version-details">
          <div><strong>Commit:</strong> <span id="dialogCurrentCommit"></span></div>
          <div><strong>Message:</strong> <span id="dialogCurrentMessage"></span></div>
          <div><strong>Date:</strong> <span id="dialogCurrentDate"></span></div>
        </div>
      </div>
      <div class="update-arrow">‚¨áÔ∏è</div>
      <div class="update-info-section highlight">
        <h3>New Version</h3>
        <div class="version-details">
          <div><strong>Commit:</strong> <span id="dialogLatestCommit"></span></div>
          <div><strong>Message:</strong> <span id="dialogLatestMessage"></span></div>
          <div><strong>Author:</strong> <span id="dialogLatestAuthor"></span></div>
          <div><strong>Date:</strong> <span id="dialogLatestDate"></span></div>
        </div>
      </div>
      <div id="dialogUpdateStatus" class="dialog-status" style="display:none;"></div>
    </div>
    <div class="dialog-footer">
      <button onclick="document.getElementById('updateDialog').close()" class="btn-secondary">Cancel</button>
      <button onclick="performUpdate()" class="btn-primary" id="dialogUpdateBtn">Install Update</button>
    </div>
  </dialog>

  <!-- Update Log Modal -->
  <dialog id="updateLogModal" class="log-dialog">
    <div class="dialog-header">
      <h2>üìú Update Log</h2>
      <button class="close-btn" onclick="document.getElementById('updateLogModal').close()">‚úï</button>
    </div>
    <div class="dialog-content">
      <div class="log-container">
        <pre id="updateLogContent" class="log-content">Waiting for logs...</pre>
      </div>
    </div>
    <div class="dialog-footer">
      <button onclick="document.getElementById('updateLogModal').close()" class="btn-primary">Close</button>
    </div>
  </dialog>

  <!-- Update Success Dialog -->
  <dialog id="updateSuccessDialog" class="success-dialog">
    <div class="dialog-content text-center">
      <div class="success-icon">‚úÖ</div>
      <h2>Update Initiated!</h2>
      <p>The system is restarting to apply changes.</p>
      <div class="countdown-container">
        <span id="reloadCountdown">15</span>
        <span class="countdown-label">seconds until reload</span>
      </div>
    </div>
  </dialog>

  <!-- Rollback Dialog -->
  <dialog id="rollbackDialog">
    <h2>Rollback to Backup</h2>
    <p>Select a backup to restore:</p>
    <select id="backupSelect"></select>
    <button onclick="doRollback()">Rollback</button>
    <button onclick="document.getElementById('rollbackDialog').close()">Cancel</button>
    <div id="rollbackStatus"></div>
  </dialog>

  <!-- Completeness Summary Dialog -->
  <dialog id="summaryDialog" class="preview-dialog">
    <div class="preview-header">
      <h2>Completeness Summary</h2>
      <button class="close-btn" onclick="document.getElementById('summaryDialog').close()">‚úï</button>
    </div>
    <div id="summaryDialogContent" class="preview-content"></div>
    <div class="preview-footer">
      <button onclick="document.getElementById('summaryDialog').close()">Close</button>
    </div>
  </dialog>

  <!-- File Preview Dialog -->
  <dialog id="filePreviewDialog" class="preview-dialog">
    <div class="preview-header">
      <h2 id="previewFileName"></h2>
      <button class="close-btn" onclick="document.getElementById('filePreviewDialog').close()">‚úï</button>
    </div>
    <div class="preview-controls">
      <div class="view-mode-toggle">
        <button id="viewModeFinal" class="toggle-btn active" onclick="switchViewMode('final')">Final View</button>
        <button id="viewModeDiff" class="toggle-btn" onclick="switchViewMode('diff')">Diff View</button>
      </div>
      <div id="diffLegend" class="diff-legend" style="display: none;">
        <span class="legend-item"><span class="legend-add">+</span> Added</span>
        <span class="legend-item"><span class="legend-del">-</span> Deleted</span>
        <span class="legend-item"><span class="legend-mod">~</span> Modified</span>
      </div>
    </div>
    <div id="previewContentWrapper" class="preview-content-wrapper">
      <pre id="previewContent" class="preview-content"></pre>
      <div id="diffContent" class="diff-content" style="display: none;"></div>
    </div>
    <div class="preview-footer">
      <button onclick="document.getElementById('filePreviewDialog').close()">Close</button>
    </div>
  </dialog>

  <script src="/static/app.js"></script>
</body>

</html>